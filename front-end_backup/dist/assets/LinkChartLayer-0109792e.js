import{_ as Se,eN as He,V as Ce,b3 as ke,A as ie,n as H,aQ as $e,M as Oe,a$ as Me,b1 as be,i as v,y as A,j as Be,cl as Fe}from"./index-c6cfe049.js";import{o as q}from"./featureConversionUtils-830d3ed6.js";import{a as Ee}from"./OptimizedFeature-059c854c.js";import{M as Ue,h as ze,a as ue,w as _,b as ne,c as re,D as x,I as je}from"./KnowledgeGraphSublayer-4ab47e9d.js";import{l as Qe}from"./BlendLayer-3864a0e6.js";import{t as Ve}from"./ScaleRangeLayer-2709e17c.js";import{R as Ye}from"./knowledgeGraphService-7584f89b.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./UniqueValueRenderer-2d905f9d.js";import"./ColorStop-3bd1e817.js";import"./diffUtils-a81eba90.js";import"./colorRamps-2725f079.js";import"./sizeVariableUtils-d4870b0d.js";import"./visualVariableUtils-57487c58.js";import"./lengthUtils-806c8c03.js";import"./jsonUtils-17af088a.js";import"./defaults-458d9190.js";import"./defaultsJSON-59981e75.js";import"./styleUtils-12717ade.js";import"./jsonUtils-0cfa0239.js";import"./LRUCache-be26918b.js";import"./Version-d58b3305.js";import"./FieldsIndex-815a254a.js";import"./UnknownTimeZone-b1c85c08.js";import"./OverrideHelper-78bed9ed.js";import"./colorUtils-60e0b64a.js";import"./vec42-614f5847.js";import"./vec4f64-430e4feb.js";import"./utils-2af5df8d.js";import"./quantizationUtils-07a0781e.js";import"./heatmapUtils-dc73c34c.js";import"./MultiOriginJSONSupport-7cf2254f.js";import"./FeatureStore-81a6f478.js";import"./BoundsStore-7efb30cd.js";import"./PooledRBush-c841393a.js";import"./timeSupport-b14221ad.js";import"./json-48e3ea08.js";import"./QueryEngine-61769534.js";import"./WhereClause-7f089e1b.js";import"./TimeOnly-430d9cda.js";import"./QueryEngineCapabilities-85c4f1d0.js";import"./utils-23dcd7dc.js";import"./utils-c1c7e04b.js";import"./utils-ef13d521.js";import"./ClassBreaksDefinition-de3e12a5.js";import"./clientSideDefaults-bc8f2b5a.js";import"./GraphQueryStreaming-d186a353.js";import"./fieldProperties-abc74b98.js";import"./FeatureEffectLayer-ad153b3a.js";import"./FeatureEffect-0fa11288.js";import"./jsonUtils-a377b268.js";import"./parser-7740a44f.js";import"./FeatureReductionLayer-d2b80ebd.js";import"./commonProperties-b537568a.js";import"./ElevationInfo-58ee6e4f.js";import"./FeatureReductionSelection-4696fdf2.js";import"./featureLayerUtils-6e37b4eb.js";import"./RelationshipQuery-21a3a6e4.js";import"./labelingInfo-754601fb.js";import"./labelUtils-e96173b2.js";import"./MD5-715f37cd.js";import"./OrderedLayer-4b37be9f.js";import"./OrderByInfo-3aa9a06f.js";import"./RefreshableLayer-768cbb26.js";import"./TemporalLayer-58903be1.js";import"./TimeInfo-3ab6fbf6.js";import"./FeatureSet-402c1fc5.js";import"./popupUtils-c2bd8f97.js";var oe;(function(e){e.MULTIPLIER="multiplier",e.ABSOLUTE="absoluteValue"})(oe||(oe={}));let de,L=null;function We(){return de||(de=Se(()=>import("./lclayout-10cd7555.js"),["assets/lclayout-10cd7555.js","assets/index-c6cfe049.js","assets/index-16a932bd.css"]).then(e=>e.l).then(({default:e})=>e({locateFile:i=>He(`esri/libs/linkchartlayout/${i}`)})).then(e=>{qe(e)}),de)}function qe(e){L=e}var $,se;function V(e,i,a,t,s,l){const n=a.length,p=s.length,C=Float64Array.BYTES_PER_ELEMENT,d=Uint32Array.BYTES_PER_ELEMENT,c=Uint8Array.BYTES_PER_ELEMENT,r=16,m=r+n*(c+2*C)+p*(2*d),f=L._malloc(m);try{const h=f+r-f%r,M=h+n*C,b=M+n*C,D=b+p*d,I=D+p*d,y=()=>[L.HEAPF64.subarray(h>>3,(h>>3)+n),L.HEAPF64.subarray(M>>3,(M>>3)+n),L.HEAPU32.subarray(b>>2,(b>>2)+p),L.HEAPU32.subarray(D>>2,(D>>2)+p),L.HEAPU8.subarray(I,I+n)],[R,F,O,U,B]=y();R.set(a),F.set(t),O.set(s),U.set(l),B.set(i);let S=e(n,I,h,M,p,b,D),T=null,P=null;if(S){const Y=L.getLayoutLinksTypes(),o=L.getLayoutLinksVerticesEndIndices(),u=L.getLayoutLinksVertices(),g=L.countLayoutLinksVertices();!p||Y&&o?g&&!u?S=!1:(T={types:new Uint8Array(L.HEAPU8.subarray(Y,Y+p)),vertexEndIndex:new Uint32Array(L.HEAPU32.subarray(o>>2,(o>>2)+p)),vertices:new Float64Array(L.HEAPF64.subarray(u>>3,(u>>3)+2*g))},P=L.getAuxiliaryGraphicElements()):S=!1}const[J,K,X,Z,ee]=y();return a.set(J),t.set(K),s.set(X),l.set(Z),i.set(ee),{success:S,links:T,graphics:P}}finally{L._free(f),L.cleanupLayout()}}(function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot"})($||($={})),function(e){e[e.Regular=0]="Regular",e[e.Orthogonal=1]="Orthogonal",e[e.Curved=2]="Curved",e[e.Recursive=3]="Recursive"}(se||(se={}));const we=2,Te=1,De=-1;var ce,ye,me,ge,fe,Le,xe,Ne,ve;(function(e){function i(){return L.getMinIdealEdgeLength()}function a(t,s,l,n,p,C=we,d=Te,c=De){return V((r,m,f,h,M,b,D)=>L.applyForceDirectedLayout(r,m,f,h,M,b,D,C,d,c),t,s,l,n,p)}e.getMinIdealEdgeLength=i,e.apply=a})(ce||(ce={})),function(e){function i(a,t,s,l,n,p=we,C=Te,d=De){return V((c,r,m,f,h,M,b)=>L.applyCommunityLayout(c,r,m,f,h,M,b,p,C,d),a,t,s,l,n)}e.apply=i}(ye||(ye={})),function(e){function i(a,t,s,l,n){return V(L.applySimpleLayout,a,t,s,l,n)}e.apply=i}(me||(me={})),function(e){function i(a,t,s,l,n){return V(L.applyHierarchicalLayout,a,t,s,l,n)}e.apply=i}(ge||(ge={})),function(e){function i(a,t,s,l,n){return V(L.applyRadialTreeLayout,a,t,s,l,n)}e.apply=i}(fe||(fe={})),function(e){function i(a,t,s,l,n){return V(L.applySmartTreeLayout,a,t,s,l,n)}e.apply=i}(Le||(Le={})),function(e){function i(a,t,s,l,n,p,C,d,c){return V((r,m,f,h,M,b,D)=>{if(l.length!==r||n.length!==r||d.length!==M||c.length!==M)return!1;const I=Float64Array.BYTES_PER_ELEMENT,y=16,R=L._malloc(y+r*I),F=L._malloc(y+r*I),O=L._malloc(y+M*I),U=L._malloc(y+M*I),B=R+y-R%y,S=F+y-F%y,T=O+y-O%y,P=U+y-U%y;try{return L.HEAPF64.subarray(B>>3,(B>>3)+r).set(l),L.HEAPF64.subarray(S>>3,(S>>3)+r).set(n),L.HEAPF64.subarray(T>>3,(T>>3)+M).set(d),L.HEAPF64.subarray(P>>3,(P>>3)+M).set(c),L.applyChronologicalLayout(r,m,f,h,B,S,M,b,D,T,P)}finally{L._free(R),L._free(F),L._free(O),L._free(U)}},a,t,s,p,C)}e.apply=i}(xe||(xe={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(Ne||(Ne={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(ve||(ve={}));let N=class extends Qe(Ve(Fe)){constructor(e){if(super(e),this.dataPreloadedInLocalCache=!1,this.defaultLinkChartConfig=null,this._currentLinkChartConfig={layoutMode:"RADIAL_TREE"},this._graphTypeLookup=new Map,this.dataManager=null,this.knowledgeGraph=null,this.layers=new Ce,this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map,this.linkChartExtent=new ke({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7}),this.memberEntityTypes=null,this.memberRelationshipTypes=null,this.sublayerIdsCache=new Map,this.tables=new Ce,this.type="link-chart",this._originalInclusionList=e.inclusionModeDefinition,e.dataPreloadedInLocalCache&&!e.inclusionModeDefinition)throw new ie("knowledge-graph:linkchart-layer-constructor","If creating a link chart composite layer and configured that data is already loaded in the cache, you must specify an inclusion list so the Composite Layer knows what records belong to it")}normalizeCtorArgs(e){return{url:e.url,title:e.title,dataPreloadedInLocalCache:e.dataPreloadedInLocalCache,defaultLinkChartConfig:e.defaultLinkChartConfig}}_initializeLayerProperties(e){var l,n,p,C,d,c;if(!this.title&&this.url){const r=this.url.split("/");this.title=r[r.length-2]}const i=new Set;let a=[],t=[];if(e.inclusionModeDefinition&&(!e.inclusionModeDefinition.namedTypeDefinitions||e.inclusionModeDefinition.namedTypeDefinitions.size<1))throw new ie("knowledge-graph:composite-layer-constructor","If an explicit inclusion definition is defined, at least one namedTypeDefinition must also be defined");(l=e.knowledgeGraph.dataModel.entityTypes)==null||l.forEach(r=>{r.name&&this._graphTypeLookup.set(r.name,r)}),(n=e.knowledgeGraph.dataModel.relationshipTypes)==null||n.forEach(r=>{r.name&&this._graphTypeLookup.set(r.name,r)}),(p=e.inclusionModeDefinition)!=null&&p.generateAllSublayers?(a=e.knowledgeGraph.dataModel.entityTypes??[],t=e.knowledgeGraph.dataModel.relationshipTypes??[]):(C=e.inclusionModeDefinition)!=null&&C.namedTypeDefinitions&&((d=e.inclusionModeDefinition)==null?void 0:d.namedTypeDefinitions.size)>0?(c=e.inclusionModeDefinition)==null||c.namedTypeDefinitions.forEach((r,m)=>{var h,M;const f=this._graphTypeLookup.get(m);if(!f)return H.getLogger(this).warn(`A named type, ${m}, was in the inclusion list that wasn't in the data model and will be removed`),void((h=e.inclusionModeDefinition)==null?void 0:h.namedTypeDefinitions.delete(m));f.type==="relationship"?i.has(m)||(i.add(m),t.push(f)):f.type==="entity"?i.has(m)||(i.add(m),a.push(f)):(H.getLogger(this).warn(`A named type, ${m}, was in the inclusion list that wasn't properly modeled and will be removed`),(M=e.inclusionModeDefinition)==null||M.namedTypeDefinitions.delete(m))}):(a=e.knowledgeGraph.dataModel.entityTypes??[],t=e.knowledgeGraph.dataModel.relationshipTypes??[]);const s=new Ue({knowledgeGraph:e.knowledgeGraph,inclusionModeDefinition:e.inclusionModeDefinition});this.knowledgeGraph=e.knowledgeGraph,this.memberEntityTypes=a,this.memberRelationshipTypes=t,this.dataManager=s}load(e){return this.addResolvingPromise(new Promise(i=>{Ye(this.url).then(a=>{var t,s,l,n,p,C;if(this._initializeLayerProperties({knowledgeGraph:a,inclusionModeDefinition:this._originalInclusionList}),(s=(t=this.dataManager.inclusionModeDefinition)==null?void 0:t.namedTypeDefinitions)!=null&&s.size||(this.dataManager.inclusionModeDefinition={generateAllSublayers:!1,namedTypeDefinitions:new Map},(l=this.dataManager.knowledgeGraph.dataModel.entityTypes)==null||l.forEach(d=>{var c;d.name&&((c=this.dataManager.inclusionModeDefinition)==null||c.namedTypeDefinitions.set(d.name,{useAllData:!0}))}),(n=this.dataManager.knowledgeGraph.dataModel.relationshipTypes)==null||n.forEach(d=>{var c;d.name&&((c=this.dataManager.inclusionModeDefinition)==null||c.namedTypeDefinitions.set(d.name,{useAllData:!0}))})),this.dataPreloadedInLocalCache)this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1),(p=this.dataManager.inclusionModeDefinition)==null||p.namedTypeDefinitions.forEach(d=>{var c;d.useAllData=!1,(c=d.members)==null||c.forEach(r=>{let m;m=r.linkChartLocation instanceof Ee?r.linkChartLocation:r.linkChartLocation?q(r.linkChartLocation):null,m&&m.coords.length===2&&m.lengths.length===0?this.entityLinkChartDiagramLookup.set(r.id,m):this.relationshipLinkChartDiagramLookup.set(r.id,m)}),this.addResolvingPromise(this._initializeDiagram().then(async()=>{this.layers.forEach(async r=>{await r.refreshCachedQueryEngine()}),this.tables.forEach(async r=>{await r.refreshCachedQueryEngine()})}))});else{const d=((C=this.defaultLinkChartConfig)==null?void 0:C.layoutMode)==="GEOGRAPHIC";this.addResolvingPromise(this.dataManager.refreshCacheContent(void 0,!1,d,!0).then(async()=>{$e(e);const c=[],r=[];this.loadLayerAssumingLocalCache(),this.dataManager.inclusionModeDefinition&&(this.dataManager.inclusionModeDefinition.generateAllSublayers=!1,this.dataManager.inclusionModeDefinition.namedTypeDefinitions.forEach(m=>{m.useAllData=!1})),await this._initializeDiagram(),this.layers.forEach(m=>{r.push(m.refreshCachedQueryEngine()),c.push(new Promise(f=>{m.on("layerview-create",()=>{f(null)})}))}),this.tables.forEach(m=>{r.push(m.refreshCachedQueryEngine())}),await Promise.all(r)}))}i(null)})})),Promise.resolve(this)}async addRecords(e,i){let a=[];i!=null&&i.cascadeAddRelationshipEndNodes&&this.dataManager.knowledgeGraph.dataModel&&(a=await ze(e,this.dataManager.knowledgeGraph));const t=e.concat(a).filter(s=>{var l;return!((l=this.sublayerIdsCache.get(s.typeName))!=null&&l.has(s.id))});await this._handleNewRecords(t)}async removeRecords(e,{cascadeRemoveRelationships:i=!0,recalculateLayout:a=!1}={cascadeRemoveRelationships:!0,recalculateLayout:!1}){var l,n,p,C,d,c,r,m;let t=[];for(const f of e)((p=(n=(l=this.dataManager.inclusionModeDefinition)==null?void 0:l.namedTypeDefinitions)==null?void 0:n.get(f.typeName))==null?void 0:p.useAllData)===!1&&((r=(c=(d=(C=this.dataManager.inclusionModeDefinition)==null?void 0:C.namedTypeDefinitions)==null?void 0:d.get(f.typeName))==null?void 0:c.members)!=null&&r.has(f.id))&&t.push(f);if(i){const f=new Set,h=[];for(const M of t)if(this.dataManager.nodeConnectionsLookup.has(M.id))for(const b of this.dataManager.nodeConnectionsLookup.get(M.id))f.add(b);for(const M of f)if(this.dataManager.memberIdTypeLookup.has(M))for(const b of this.dataManager.memberIdTypeLookup.get(M))this.dataManager.relationshipTypeNames.has(b)&&h.push({id:M,typeName:b});t=t.concat(h)}this.dataManager.removeFromLayer(t);for(const f of t)(m=this.sublayerIdsCache.get(f.typeName))==null||m.delete(f.id),this.dataManager.relationshipTypeNames.has(f.typeName)?this.relationshipLinkChartDiagramLookup.delete(f.id):this.entityLinkChartDiagramLookup.delete(f.id);a&&await this.calculateLinkChartLayout(this._currentLinkChartConfig.layoutMode,this._currentLinkChartConfig.layoutOptions);const s=[];return this.layers.forEach(f=>{s.push(f.refreshCachedQueryEngine())}),await Promise.all(s),this._refreshNamedTypes(),t}async expand(e,i){const a=await this.dataManager.getConnectedRecordIds(e,i),t=a.filter(s=>{var l;return!((l=this.sublayerIdsCache.get(s.typeName))!=null&&l.has(s.id))});return await this._handleNewRecords(a),{records:t}}loadLayerAssumingLocalCache(){var e,i;this.memberRelationshipTypes.forEach(a=>{const t=new ue({objectType:a,parentCompositeLayer:this,graphType:"relationship",title:a.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(a.name)||this.dataManager.sublayerCaches.set(a.name,new Map)}),this.memberEntityTypes.forEach(a=>{const t=new ue({objectType:a,parentCompositeLayer:this,graphType:"entity",title:a.name});t.geometryType?this.layers.push(t):this.tables.push(t),this.dataManager.sublayerCaches.has(a.name)||this.dataManager.sublayerCaches.set(a.name,new Map)}),(e=this.dataManager.inclusionModeDefinition)!=null&&e.namedTypeDefinitions&&((i=this.dataManager.inclusionModeDefinition)==null||i.namedTypeDefinitions.forEach((a,t)=>{var l;const s=Oe(this.sublayerIdsCache,t,()=>new Set);(l=a.members)==null||l.forEach(n=>{if(s.add(n.id),n.linkChartLocation)if(n.linkChartLocation instanceof Ee)this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(n.id,n.linkChartLocation):this.entityLinkChartDiagramLookup.set(n.id,n.linkChartLocation);else{const p=q(n.linkChartLocation);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(n.id,n.linkChartLocation?p:null):this.entityLinkChartDiagramLookup.set(n.id,n.linkChartLocation?p:null)}})}))}async calculateLinkChartLayout(e="RADIAL_TREE",i){var Z,ee,Y;const a=[],t=[],s=[];this.dataManager.sublayerCaches.forEach((o,u)=>{this.dataManager.entityTypeNames.has(u)?o.forEach(g=>{a.push({typeName:u,feature:g})}):this.dataManager.relationshipTypeNames.has(u)&&o.forEach(g=>{t.push({typeName:u,feature:g})})}),this.entityLinkChartDiagramLookup=new Map,this.relationshipLinkChartDiagramLookup=new Map;const l=new Map,n=new Map,p=new Map,C=new Map,d=new Uint8Array(a.length),c=new Float64Array(a.length),r=new Float64Array(a.length),m=new Uint32Array(t.length),f=new Uint32Array(t.length),h=[],M="FORCE_DIRECTED",b=new ke({xmin:-1e-7,ymin:-1e-7,xmax:1e-7,ymax:1e-7});let D,I="FORCE_DIRECTED",y=0,R=0;switch(I=e==="GEOGRAPHIC"?M:e,I){case"FORCE_DIRECTED":D=ce.apply;break;case"COMMUNITY":D=ye.apply;break;case"HIERARCHICAL":D=ge.apply;break;case"RADIAL_TREE":D=fe.apply;break;case"SMART_TREE":D=Le.apply;break;default:D=me.apply}a.forEach(({typeName:o,feature:u})=>{var g,z,j;if((g=i==null?void 0:i.lockedNodeLocations)!=null&&g.has(u.attributes[_])){e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(o)?d[y]=$.IsGeographic:d[y]=$.None;const k=i.lockedNodeLocations.get(u.attributes[_]);c[y]=k.x,r[y]=k.y}else if(e==="GEOGRAPHIC"&&this.dataManager.geographicLookup.has(o)){d[y]=$.IsGeographic;let k=null;const E=u.attributes[this.dataManager.geographicLookup.get(o).name];switch((z=this.dataManager.geographicLookup.get(o))==null?void 0:z.geometryType){case"esriGeometryPoint":c[y]=E==null?void 0:E.x,r[y]=E==null?void 0:E.y;break;case"esriGeometryPolygon":k=E==null?void 0:E.centroid,(k==null?void 0:k.x)!=null&&(k==null?void 0:k.y)!=null?(c[y]=k.x,r[y]=k.y):d[y]=$.IsMovable;break;case"esriGeometryPolyline":case"esriGeometryMultipoint":k=(j=E==null?void 0:E.extent)==null?void 0:j.center,(k==null?void 0:k.x)!=null&&(k==null?void 0:k.y)!=null?(c[y]=k.x,r[y]=k.y):d[y]=$.IsMovable;break;default:d[y]=$.IsMovable}(c[y]==null||r[y]==null||Number.isNaN(c[y])||Number.isNaN(r[y]))&&(d[y]=$.IsMovable,c[y]=0,r[y]=0)}else d[y]=$.IsMovable,c[y]=0,r[y]=0;C.set(u.attributes[_],y),h[y]={feature:u,typeName:o},y++});let F=!1;const O=new Map;t.forEach(o=>{const u=o.feature.attributes[ne],g=o.feature.attributes[re],z=C.get(u),j=C.get(g);if(z!==void 0&&j!==void 0){const k=u+"-"+g,E=O.get(k);(E==null?void 0:E.has(o.typeName))||(m[R]=z,f[R]=j,E===void 0?O.set(k,new Map([[o.typeName,R]])):E.set(o.typeName,R),R++),s.push(o)}else F=!0,this.relationshipLinkChartDiagramLookup.set(u,null)}),F&&H.getLogger(this).warn("A relationship is a member of this layer that has either origin or destination entity nodes that are not members. The diagram geometry will be set to null");const U=this._validateLayoutSettings(e,i),B=this._convertLayoutSettingsToCalculationSettings(U);await We();const{success:S,links:T}=D(d,c,r,m.subarray(0,R),f.subarray(0,R),B.computationBudgetTime,B.idealEdgeLengthMultiplier,B.repulsionRadiusMultiplier);if(!S)throw new ie("knowledge-graph:layout-failed","Attempting to arrange the records in the specified layout failed");for(let o=0;o<h.length;o++){if(r[o]>84.9999?r[o]=84.9999:r[o]<-84.9999&&(r[o]=-84.9999),c[o]>179.9999?c[o]=179.9999:c[o]<-179.9999&&(c[o]=-179.9999),h[o].feature.attributes[x]=new Me(c[o],r[o]),l.has(h[o].typeName)){const g=l.get(h[o].typeName);g==null||g.set(h[o].feature.attributes[_],h[o].feature)}else{const g=new Map;g.set(h[o].feature.attributes[_],h[o].feature),l.set(h[o].typeName,g)}p.set(h[o].feature.attributes[_],h[o].feature);const u=q(h[o].feature.attributes[x]);this.entityLinkChartDiagramLookup.set(h[o].feature.attributes[_],h[o].feature.attributes[x]?u:null),h[o].feature.attributes[x].x<b.xmin&&(b.xmin=h[o].feature.attributes[x].x),h[o].feature.attributes[x].x>b.xmax&&(b.xmax=h[o].feature.attributes[x].x),h[o].feature.attributes[x].y<b.ymin&&(b.ymin=h[o].feature.attributes[x].y),h[o].feature.attributes[x].y>b.ymax&&(b.ymax=h[o].feature.attributes[x].y)}if(this.linkChartExtent.xmin=b.xmin,this.linkChartExtent.xmax=b.xmax,this.linkChartExtent.ymin=b.ymin,this.linkChartExtent.ymax=b.ymax,!T)throw new ie("knowledge-graph:layout-failed","Attempting to retrieve link geometry from diagram engine failed");const P=new Map,J=new Map,K=new Map,X=new Set;for(let o=0;o<s.length;o++){const u=[],g=s[o],z=g.feature.attributes[ne],j=g.feature.attributes[re],k=z+"-"+j,E=O.get(k).get(g.typeName),Q=E===0?0:T==null?void 0:T.vertexEndIndex[E-1];if(!X.has(E)){if(X.add(E),T.types[E]===se.Recursive){const w=[T.vertices[2*Q],T.vertices[2*Q+1]],pe=[T.vertices[2*(Q+1)],T.vertices[2*(Q+1)+1]],W=[.5*(w[0]+pe[0]),.5*(w[1]+pe[1])],ae=[W[0]-w[0],W[1]-w[1]],Pe=[W[0]+ae[1],W[1]-ae[0]],Ge=[W[0]-ae[1],W[1]+ae[0]];u.push(w),u.push(Pe),u.push(pe),u.push(Ge),u.push(w)}else{if(T.types[E]!==se.Regular){H.getLogger(this).warn("A relationship generated an unsupported link geometry type.  It will not be rendered");continue}for(let w=Q;w<T.vertexEndIndex[E];w++)u.push([T.vertices[2*w],T.vertices[2*w+1]])}const G=(Z=h[C.get(z)])==null?void 0:Z.feature.attributes[x],te=(ee=h[C.get(j)])==null?void 0:ee.feature.attributes[x];u[0][0]===G.x&&u[0][1]===G.y||(u[0]=[G.x,G.y]),u[u.length-1][0]===te.x&&u[u.length-1][1]===te.y||(u[u.length-1]=[te.x,te.y]);for(let w=1;w<u.length-1;w++)u[w][1]>85.5?u[w][1]=85.5:u[w][1]<-85.5&&(u[w][1]=-85.5),u[w][0]>179.9999?u[w][0]=179.9999:u[w][0]<-179.9999&&(u[w][0]=-179.9999);P.has(k)?P.get(k).push(u):P.set(k,[u])}const Re=P.get(k);J.has(k)||(J.set(k,new Map),K.set(k,new Map));const le=J.get(k),he=K.get(k);le.has(g.typeName)||(le.set(g.typeName,Re.shift()),he.set(g.typeName,0));const Ae=le.get(g.typeName);he.set(g.typeName,he.get(g.typeName)+1);const _e=new be({paths:Ae});if(g.feature.attributes[x]=_e,n.has(g.typeName)){const G=n.get(g.typeName);G==null||G.set(g.feature.attributes[_],g.feature)}else{const G=new Map;G.set(g.feature.attributes[_],g.feature),n.set(g.typeName,G)}p.set(g.feature.attributes[_],g.feature);const Ie=q(g.feature.attributes[x]);this.relationshipLinkChartDiagramLookup.set(g.feature.attributes[_],g.feature.attributes[x]?Ie:null)}for(const o of s)o.feature.attributes[je]=((Y=K.get(o.feature.attributes[ne]+"-"+o.feature.attributes[re]))==null?void 0:Y.get(o.typeName))??null;return this._currentLinkChartConfig={layoutMode:e,layoutOptions:U},{nodes:l,links:n,idMap:p}}async applyNewLinkChartLayout(e="RADIAL_TREE",i){const a=[];await this.calculateLinkChartLayout(e,i),this.layers.forEach(t=>{a.push(t.refreshCachedQueryEngine())}),await Promise.all(a),this._refreshNamedTypes()}getCurrentNodeLocations(){var i,a;const e=new Map;return(a=(i=this.dataManager.inclusionModeDefinition)==null?void 0:i.namedTypeDefinitions)==null||a.forEach(t=>{var s;(s=t==null?void 0:t.members)==null||s.forEach(l=>{const n=l.linkChartLocation;let p;const C=l.id;n&&(p="x"in n?{x:n.x,y:n.y}:{x:n.coords[0],y:n.coords[1]},e.set(C,new Me({x:p.x,y:p.y})))})}),e}async synchronizeInclusionListWithCache(){return new Promise(e=>{var i;(i=this.dataManager.inclusionModeDefinition)==null||i.namedTypeDefinitions.forEach((a,t)=>{if(a.useAllData=!1,a.members&&a.members.size>0){if(!this.dataManager.sublayerCaches.get(t))return;const s=new Set(Array.from(this.dataManager.sublayerCaches.get(t).keys()));Array.from(a.members.keys()).filter(l=>!s.has(l)).forEach(l=>{var n;(n=a.members)==null||n.delete(l)})}}),e()})}async refreshLinkChartCache(e){await this.dataManager.refreshCacheContent(e);const i=[];this.layers.forEach(a=>{i.push(a.refreshCachedQueryEngine())}),await Promise.all(i),this._refreshNamedTypes()}async connectEntities(e){let i=[];for(const t of this.dataManager.relationshipTypeNames){const s=this.sublayerIdsCache.get(t);s&&(i=i.concat(Array.from(s.keys())))}const a=await this.dataManager.getAttachedRelationships(e,i);return await this._handleNewRecords(a),{records:a}}async _handleNewRecords(e){const i=[];this.dataManager.addToLayer(e);for(const t of e)this.sublayerIdsCache.has(t.typeName)||(this.sublayerIdsCache.set(t.typeName,new Set),i.push(t.typeName)),this.sublayerIdsCache.get(t.typeName).add(t.id);for(const t of i){const s=this._graphTypeLookup.get(t);if(s){const l=new ue({objectType:s,parentCompositeLayer:this,graphType:s.type,title:t});s.type==="entity"?this.dataManager.entityTypeNames.add(t):this.dataManager.relationshipTypeNames.add(t),l.geometryType?this.layers.push(l):this.tables.push(l),this.dataManager.sublayerCaches.set(t,new Map)}}await this.dataManager.refreshCacheContent(e.map(t=>t.id));const a=Object.assign({},this._currentLinkChartConfig.layoutOptions);a.lockedNodeLocations=this.getCurrentNodeLocations(),await this.applyNewLinkChartLayout(this._currentLinkChartConfig.layoutMode,a)}async _initializeDiagram(){var e,i;this.defaultLinkChartConfig?this.defaultLinkChartConfig.doNotRecalculateLayout?((i=(e=this.dataManager.inclusionModeDefinition)==null?void 0:e.namedTypeDefinitions)==null||i.forEach((a,t)=>{var s;(s=a==null?void 0:a.members)==null||s.forEach(l=>{const n=l.linkChartLocation;let p;const C=l.id;if(!n)return;p="x"in n?{x:n.x,y:n.y}:{x:n.coords[0],y:n.coords[1]};const d=q(p);this.dataManager.relationshipTypeNames.has(t)?this.relationshipLinkChartDiagramLookup.set(C,d):this.entityLinkChartDiagramLookup.set(C,d),this.linkChartExtent.xmin>p.x&&(this.linkChartExtent.xmin=p.x),this.linkChartExtent.xmax<p.x&&(this.linkChartExtent.xmax=p.x),this.linkChartExtent.ymin>p.y&&(this.linkChartExtent.ymin=p.y),this.linkChartExtent.ymax<p.y&&(this.linkChartExtent.ymax=p.y)})}),this.memberRelationshipTypes.forEach(a=>{var t;a.name&&((t=this.dataManager.sublayerCaches.get(a.name))==null||t.forEach(s=>{const l=this.relationshipLinkChartDiagramLookup.get(s.attributes[ne]),n=this.relationshipLinkChartDiagramLookup.get(s.attributes[re]);if(l&&n){const p=q(new be({paths:[[l.coords[0],l.coords[1]],[n.coords[0],n.coords[1]]]}));this.relationshipLinkChartDiagramLookup.set(s.attributes[_],p)}else this.relationshipLinkChartDiagramLookup.set(s.attributes[_],null)}))})):await this.calculateLinkChartLayout(this.defaultLinkChartConfig.layoutMode,{lockedNodeLocations:this.getCurrentNodeLocations(),...this.defaultLinkChartConfig.layoutOptions||{}}):await this.calculateLinkChartLayout("RADIAL_TREE",{lockedNodeLocations:this.getCurrentNodeLocations()})}_refreshNamedTypes(){for(const e of this.layers)e.emit("refresh",{dataChanged:!0});for(const e of this.tables)e.emit("refresh",{dataChanged:!0})}_validateLayoutSettings(e,i){const a=h=>typeof h=="number"&&!isNaN(h),t=h=>a(h)&&h>=1,s=h=>a(h)&&h>=1,l=h=>Object.values(oe).includes(h),n=h=>a(h)&&h>=0,p=new Set(["FORCE_DIRECTED","COMMUNITY","GEOGRAPHIC"]),C={};if(!p.has(e)||!i)return!p.has(e)&&i&&H.getLogger(this).warn("Layout mode options were given for a layout mode that does not utilize them, settings will be ignored"),C;const{computationBudgetTime:d,repulsionRadiusMultiplier:c,idealEdgeLength:r,idealEdgeLengthType:m}=i;s(d)?C.computationBudgetTime=d:d!==void 0&&H.getLogger(this).warn("Invalid layout computationBudgetTime setting, will revert to default setting"),t(c)?C.repulsionRadiusMultiplier=c:c!==void 0&&H.getLogger(this).warn("Invalid layout repulsionRadiusMultiplier setting, will revert to default setting");const f=r!==void 0||m!==void 0;return e!=="GEOGRAPHIC"&&f?H.getLogger(this).warn("Ideal edge length settings were specified for an incompatible layout mode, and will be ignored"):e==="GEOGRAPHIC"&&f&&(l(m)?C.idealEdgeLengthType=m:m!==void 0&&H.getLogger(this).warn('Invalid layout idealEdgeLengthType setting, will revert to "multiplier" setting'),n(r)?C.idealEdgeLength=r:r!==void 0&&H.getLogger(this).warn("Invalid layout idealEdgeLength setting, will revert to default setting")),C}_convertLayoutSettingsToCalculationSettings(e){let i=e.idealEdgeLength;return e.idealEdgeLengthType===oe.ABSOLUTE&&(i===void 0?i=-1:i*=-1),{computationBudgetTime:e.computationBudgetTime,repulsionRadiusMultiplier:e.repulsionRadiusMultiplier,idealEdgeLengthMultiplier:i}}};v([A()],N.prototype,"dataPreloadedInLocalCache",void 0),v([A()],N.prototype,"defaultLinkChartConfig",void 0),v([A()],N.prototype,"dataManager",void 0),v([A()],N.prototype,"knowledgeGraph",void 0),v([A()],N.prototype,"layers",void 0),v([A()],N.prototype,"entityLinkChartDiagramLookup",void 0),v([A()],N.prototype,"relationshipLinkChartDiagramLookup",void 0),v([A()],N.prototype,"linkChartExtent",void 0),v([A()],N.prototype,"memberEntityTypes",void 0),v([A()],N.prototype,"memberRelationshipTypes",void 0),v([A()],N.prototype,"sublayerIdsCache",void 0),v([A()],N.prototype,"tables",void 0),v([A({json:{read:!1}})],N.prototype,"type",void 0),N=v([Be("esri.layers.LinkChartLayer")],N);const pa=N;export{pa as default};
